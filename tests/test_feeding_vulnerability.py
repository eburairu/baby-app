import pytest
from datetime import datetime
from app.dependencies import get_current_user, get_current_baby
from app.main import app
from app.models.feeding import Feeding

@pytest.mark.asyncio
async def test_create_feeding_without_baby_id(client, db, test_user, test_baby):
    """
    Vulnerability reproduction:
    Trying to create a feeding record should fail if baby_id is not correctly injected.
    The current implementation misses baby_id in the creation logic.
    """

    # Mock authentication and context
    def mock_get_current_user():
        return test_user

    def mock_get_current_baby():
        return test_baby

    app.dependency_overrides[get_current_user] = mock_get_current_user
    app.dependency_overrides[get_current_baby] = mock_get_current_baby

    try:
        # 1. Get CSRF token
        response = await client.get("/login")
        assert response.status_code == 200
        csrf_token = response.cookies.get("csrf_token")

        # Form data for new feeding
        form_data = {
            "feeding_time": datetime.utcnow().isoformat(),
            "feeding_type": "bottle",
            "amount_ml": 100,
            "notes": "Test feeding vulnerability fix"
        }

        # Send POST request with CSRF token and HX-Request to get item partial
        response = await client.post(
            "/feedings",
            data=form_data,
            headers={"X-CSRF-Token": csrf_token, "HX-Request": "true"},
            cookies={"csrf_token": csrf_token}
        )

        # After fix, it should succeed
        assert response.status_code == 200

        # Check if record was created
        feeding = db.query(Feeding).filter(Feeding.notes == "Test feeding vulnerability fix").first()

        assert feeding is not None
        assert feeding.baby_id == test_baby.id
        assert feeding.amount_ml == 100

    finally:
        app.dependency_overrides.clear()
